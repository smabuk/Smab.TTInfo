@page "/TTLeagues/TeamSummary/{LeagueId}/{TeamName}"
@inject TTLeaguesReader _ttleagues
@attribute [StreamRendering(true)]

<PageTitle>@TeamName - @LeagueId</PageTitle>

@if (fixtures is null || fixtures.Count == 0) {
	<h1>Loading ... @TeamName ...</h1>
} else {
	<h1>@TeamName</h1>
	<div id="fixtures">
		@foreach (Match match in fixtures) {
			FixtureResult? fr;
			fixtureResults.TryGetValue(match.Id, out fr);
			<div class="card" data-result='@fr?.Result'>
				<div class="row">
					<div class="col-12 col-sm-4 col-md-4 col-lg-3">
						@if (match.Date is null) {
							<span class="postponed badge" title="Postponed">P</span>
						}
						<time datetime="@match.Time?.ToUKTime().ToString("yyyy-MM-dd HH:mm")">@match.Time?.ToUKTime().ToString("ddd dd MMM HH:mm")</time>
					</div>
					<div class="col-12 col-sm-8 col-md-8 col-lg-9">
						@if (match.HasResults) {
							<a class="badge badge-sm" href="@CalculateMatchHref(match)" target="_blank" rel="noopener">@fr?.FullScore</a>
						}
						<a href="TTLeagues/TeamSummary/@LeagueId/@(match.Home.Name.Equals(@TeamName) ? match.Away.Name : match.Home.Name)">
							<strong>@(match.Home.Name.Equals(@TeamName) ? match.Away.Name : match.Home.Name)</strong>
						</a>
						<span> @@ @match.Venue</span>
					</div>
				</div>
			</div>
		}
@* 		@foreach (Fixture fixture in fixtures) {
			FixtureResult? fr;
			fixtureResults.TryGetValue((fixture as CompletedFixture)?.Id ?? 0, out fr);
			<div class="card" data-result='@fr?.Result'>
				<div class="row">
					<div class="col-12 col-sm-4 col-md-4 col-lg-3">
						@if (fixture is PostponedFixture pf) {
							<span class="postponed badge" title="@pf.Reason">P</span>
						}
						<time datetime="@fixture.Date.ToString("yyyy-MM-dd") @(fixture.HomeTeam.Contains("Curzon") || fixture.HomeTeam.Contains("RBL") ? "19:00" : "19:30")">@fixture.Date.ToString("ddd dd MMM")@(fixture.HomeTeam.Contains("Curzon") || fixture.HomeTeam.Contains("RBL") ? " 19:00" : "") </time>
					</div>
					<div class="col-12 col-sm-8 col-md-8 col-lg-9">
						@if (fixture is CompletedFixture completedFixture1 && fr is not null) {
							<a class="badge badge-sm" href="@completedFixture1.CardURL" target="_blank" rel="noopener">@fr.FullScore</a>
						}
						<a href="TeamSummary/@LeagueId/@(fixture.HomeTeam.Equals(@team.Name) ? fixture.AwayTeam : fixture.HomeTeam)">
							<strong>@(fixture.HomeTeam.Equals(@team.Name) ? fixture.AwayTeam : fixture.HomeTeam)</strong>
						</a>
						<span> @@ @fixture.Venue</span>
					</div>
				</div>
				@if (fixture is PostponedFixture postponed) {
					<div class="row justify-content-end">
						<div class="col-12 col-md-8 col-lg-9">
							@postponed.Reason
						</div>
					</div>
				}
				@if (fixture is CompletedFixture completedFixture) {
					@if (completedFixture.Other is not null) {
						<div class="row justify-content-end">
							<div class="col-12 col-md-8 col-lg-9">
								@completedFixture.Other
							</div>
						</div>
					}
					@if (fixture.HomeTeam.Equals(@team.Name)) {
						<div class="row justify-content-end">
							<div class="col-12 col-md-8 col-lg-9">
								@foreach (MatchPlayer player in completedFixture.HomePlayers.OrderByDescending(p => p.PoM).ThenByDescending(p => p.SetsWon)) {
									<span class="@(player.PoM ? "pom" : "")"><text><a href="PlayerSummary/@LeagueId/@player.Name.Replace(" ", "_")/@player.Id">@($"{player.Name}")</a> @($" {player.SetsWon} ")</text></span>
								}
							</div>
						</div>
						<div class="row justify-content-end">
							<div class="col-12 col-md-8 col-lg-9">
								@foreach (MatchPlayer player in completedFixture.AwayPlayers.OrderByDescending(p => p.PoM).OrderByDescending(p => p.SetsWon)) {
									<span class="@(player.PoM ? "pom" : "")"><a href="PlayerSummary/@LeagueId/@player.Name.Replace(" ", "_")/@player.Id">@($"{player.Name}")</a> @($" {player.SetsWon} ")</span>
								}
							</div>
						</div>
					} else {
						<div class="row justify-content-end">
							<div class="col-12 col-md-8 col-lg-9">
								@foreach (MatchPlayer player in completedFixture.AwayPlayers.OrderByDescending(p => p.PoM).OrderByDescending(p => p.SetsWon)) {
									<span class="@(player.PoM ? "pom" : "")"><a href="PlayerSummary/@LeagueId/@player.Name.Replace(" ", "_")/@player.Id">@($"{player.Name}")</a> @($" {player.SetsWon} ")</span>
								}
							</div>
						</div>
						<div class="row justify-content-end">
							<div class="col-12 col-md-8 col-lg-9">
								@foreach (MatchPlayer player in completedFixture.HomePlayers.OrderByDescending(p => p.PoM).ThenByDescending(p => p.SetsWon)) {
									<span class="@(player.PoM ? "pom" : "")"><text><a href="PlayerSummary/@LeagueId/@player.Name.Replace(" ", "_")/@player.Id">@($"{player.Name}")</a> @($" {player.SetsWon} ")</text></span>
								}
							</div>
						</div>
					}
					<div class="row justify-content-end">
						<div class="col-12 col-sm-8 col-md-8 col-lg-9">
							Doubles: @completedFixture.DoublesWinner
						</div>
					</div>
				} else {
					<div class="row justify-content-end">
						<div class="col-12 col-md-8 col-lg-9">
							@if (fixture.HomeTeam.Equals(@team.Name)) {
								<text>@(teamPlayersList.ContainsKey(fixture.AwayTeam) ? @teamPlayersList[fixture.AwayTeam] : "Loading ...")</text>
							} else {
								<text>@(teamPlayersList.ContainsKey(fixture.HomeTeam) ? @teamPlayersList[fixture.HomeTeam] : "Loading ...")</text>
							}
						</div>
					</div>
				}
			</div>
		}
 *@
</div>
	<h2>Team Stats</h2>
	<div id="teamstats" class="card">
		<div>
			<div>Captain: <span>@team?.Captain?.Name</span></div>
			<div>Caption: <span>@teamStats?.Competition.Value > @teamStats?.Division.Value</span></div>
		</div>
		<div id="players">
			<h3>Players</h3>
			<table class="table table-bordered table-sm">
				<thead>
					<tr>
						<th>Name</th>
						<th>Played</th>
						<th>Win %</th>
						<th>Ranking</th>
						<th class="">PoM</th>
						<th>Form</th>
					</tr>
				</thead>
				<tbody>
					@foreach (var player in teamStats?.Players?.OrderByDescending(p => p.Average)?.ThenByDescending(p => p.Played)) {
						<tr>
							<td><a href="TTLeagues/PlayerSummary/@LeagueId/@player.Name.Replace(" ", "_")/@player.Id">@player.Name</a></td>
							<td><span>@(new string('0', 2 - player.Played.ToString().Length))</span>@player.Played</td>
							<td><span>@(new string('0', 3 - Math.Round(player.Average, 0).ToString("##0").Length))</span>@($"{Math.Round(player.Average, 0):##0}")%</td>
							<td><span>@(new string('0', 3 - "n/a".ToString().Length))</span>n/a</td>
							<td><span>@(new string('0', 2 - (player.Potm).ToString().Length))</span>@(player.Potm)</td>
							<td>@CalculateForm(player.Matches)</td>
						</tr>
					}
				</tbody>
			</table>
		</div>
		<div id="results">
			<h3>Results</h3>
			<table class="table table-bordered table-sm">
				<thead>
					<tr>
						<th>Opposition</th>
						<th>Home Or Away</th>
						<th>Date</th>
						<th>Score</th>
						<th>Pts</th>
						<th>Player Of The Match</th>
					</tr>
				</thead>
				<tbody>
					@foreach (var result in teamStats.Results!) {
						<tr data-result='@CalculateMatchResult(result.For, result.Against)'>
							<td><a href="TTLeagues/TeamSummary/@LeagueId/@result.Versus.Value">@result.Versus.Value</a></td>
							<td>@(result.Home ? "Home" : "Away")</td>
							<td>@result.Date.ToUKTime().ToString("dd MMM yyyy")</td>
							<td><a href="@result.MatchId" target="_blank" rel="noopener"><span>@(new string('0', 2 - $"{result.For}".Length))</span>@result.For-@result.Against<span>@(new string('0', 2 - $"{result.Against}".Length))</span></a></td>
							<td><span>@(new string('0', 2 - result.For.ToString().Length))</span>@result.For</td>
							<td>@result.Potm</td>
						</tr>
					}
				</tbody>
			</table>
		</div>
	</div>
}


@code {
	[EditorRequired]
	[Parameter]
	public string TeamName { get; set; } = "";

	[EditorRequired]
	[Parameter]
	public string LeagueId { get; set; } = "";

	private record FixtureResult(int Id, string Result, string FullScore);

	private Team? team;
	private TeamStats? teamStats;
	private List<Match> fixtures = new();
	private Dictionary<string, string> teamPlayersList = new();
	private Dictionary<int, FixtureResult> fixtureResults = new();
	private League? league;

	protected override async Task OnParametersSetAsync()
	{
		TeamName = HttpUtility.HtmlDecode(TeamName).Replace("_", " ");
		// team = null;
		fixtures = new();
		fixtureResults = new();
		StateHasChanged();
		league = await _ttleagues.GetLeague(LeagueId);
		int competitionId = league?.CurrentCompetitions.First().Id ?? -1;
		int teamId = await _ttleagues.GetId(TeamName, LookupType.Team, LeagueId, competitionId) ?? -1;

		team = await _ttleagues.GetTeam(teamId, LeagueId);
		StateHasChanged();
		teamStats = await _ttleagues.GetTeamStats(teamId, LeagueId, competitionId);
		StateHasChanged();
		List<TeamMember> teamMembers = await _ttleagues.GetTeamMembers(teamId, LeagueId);
		StateHasChanged();
		Fixtures? f = await _ttleagues.GetAllFixtures(LeagueId, competitionId);

		fixtures = f?.Matches
			.Where(f => string.Equals(f.Home.Name, TeamName, StringComparison.CurrentCultureIgnoreCase) || string.Equals(f.Away.Name, TeamName, StringComparison.CurrentCultureIgnoreCase))
			.Where(f => !(string.Equals(f.Home.Name, "Free", StringComparison.CurrentCultureIgnoreCase) || string.Equals(f.Away.Name, "Free", StringComparison.CurrentCultureIgnoreCase)))
			.OrderBy(m => m.Time)
			.ToList() ?? new();
		foreach (Match match in fixtures) {
			if (match.HasResults) {
				string result;
				string fullScore;
				if (match.Home.Name.Equals(TeamName, StringComparison.CurrentCultureIgnoreCase)) {
					result = (match.Home.Score > match.Away.Score) ? "win" : (match.Home.Score < match.Away.Score) ? "loss" : "draw";
					fullScore = $"{match.Home.Score} - {match.Away.Score}";
				} else {
					result = (match.Home.Score > match.Away.Score) ? "loss" : (match.Home.Score < match.Away.Score) ? "win" : "draw";
					fullScore = $"{match.Away.Score} - {match.Home.Score}";
				}
				fixtureResults.TryAdd(match.Id, new(match.Id, result, fullScore));
			}
		}

		// 	StateHasChanged();

		// 	List<string> teamList = fixtures.Select(t => t.HomeTeam).Union(fixtures.Select(t => t.HomeTeam)).Distinct().Where(t => t != TeamId).ToList();
		// 	List<Task<string>> tasks = new();
		// 	foreach (string team in teamList) {
		// 		tasks.Add(GetTeamPlayers(team));
		// 	}
		// await Task.WhenAll(tasks);

		// 	StateHasChanged();
		// }
	}

	// protected async Task<string> GetTeamPlayers(string teamName)
	// {
	// 	string playersString;

	// 	if (teamPlayersList.ContainsKey(teamName)) {
	// 		playersString = teamPlayersList[teamName];
	// 	} else {
	// 		ICollection<Player>? players = (await _ttleagues.GetTeamStats(LeagueId, teamName))?.Players;
	// 		if (players is null) {
	// 			return "";
	// 		}
	// 		var playersList = players
	// 			.OrderByDescending(p => p.WinPercentage)
	// 			.Select(p => $"{p.Name} ({Math.Round(p.WinPercentage, 0)}%)");
	// 		playersString = String.Join(", ", playersList);
	// 		teamPlayersList.TryAdd(teamName, playersString);
	// 	}
	// 	return playersString;
	// }

	string CalculateForm(IReadOnlyList<TeamStatsMatch> matches)
	{
		return String.Join(",", matches.Take(6).Select(m => m.Form.ToString()));
	}

	string CalculateMatchHref(Match match)
	{
		return $"https://{LeagueId}.ttleagues.com/league/{match.CompetitionId}/division/{match.DivisionId}/match/{match.Id}";
	}

	string CalculateMatchResult(int scoreFor, int scoreAgainst)
	{
		return (scoreFor - scoreAgainst) switch
		{
			> 0 => "win",
			< 0 => "loss",
			0 => "draw",
		};
	}
}
